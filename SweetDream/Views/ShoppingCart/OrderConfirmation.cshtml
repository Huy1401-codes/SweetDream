<!-- breadcrumb part start-->
<section class="breadcrumb_part">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb_iner">
                    <h2>Order Confirmation</h2>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- breadcrumb part end-->
<!--================Order Confirmation Area =================-->
<section class="checkout_area section_padding">
    <div class="container">
        @model SweetDream.Models.Order
        <div class="text-center mb-4">
            <h3 class="mb-4" style="font-weight: bold;">Order Confirmation</h3>
        </div>
        @if (TempData["Success"] != null)
        {
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                  Swal.fire({
                    title: "Success!",
                    text: "@TempData["Success"]",
                    icon: "success",
                    confirmButtonText: "OK"
                });
            });
        </script>
    }

    <div class="card p-4 shadow-sm mb-4">
        <p class="text-center" style="font-size: 18px; font-weight: bold;">
            Thank you for your order! We appreciate your support and are processing your order with care.
            If you need any assistance, feel free to reach out. We hope you enjoy your purchase!
        </p>
    </div>

    <div class="card p-4 shadow-sm mb-4">
        <h2 class="title text-center">Shipping Information</h2>
        <ul class="list-unstyled">
            <li><strong>Shipping Address:</strong> @Model.ShippingAddress</li>
            <li><strong>Phone Number:</strong> @Model.PhoneNumber</li>
            <li><strong>Customer Note:</strong> @(string.IsNullOrEmpty(Model.CustomerNote) ? "Không có ghi chú" : Model.CustomerNote)</li>
        </ul>
    </div>

    <div class="card p-4 shadow-sm">
        <h2 class="title text-center">Order Products</h2>
        @{
           
            var cultureVN = System.Globalization.CultureInfo.GetCultureInfo("vi-VN");
        }
        <table class="table table-hover text-center">
            <thead class="bg-warning text-white">
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Discount</th>
                    <th>Total Item Price</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.OrderDetails)
                {
                    <tr>
                        <td>
                            <img src="~/img/product/@item.Product.Image" alt="@item.Product.ProductName"
                                 class="img-thumbnail" style="width: 80px; height: 80px;">
                            <br />
                            @item.Product.ProductName
                        </td>
                        <td>@item.Quantity</td>
                        <td>@item.Price.ToString("C0", cultureVN)</td> 
                        <td>
                            @if (item.Discount > 0)
                            {
                                @((item.Discount).ToString("C0", cultureVN)) 
                            }
                            else
                            {
                                <span>0 ₫</span> 
                            }
                        </td>
                        <td>
                            @((item.Quantity * (item.Price - item.Discount)).ToString("C0", cultureVN)) 
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="text-end my-4">
        @{
            var totalAmount = Model.OrderDetails.Sum(od => od.Quantity * (od.Price - od.Discount));
        }
        <h3 class="fw-bold" style="color: #E2171A;">Tổng cộng: @totalAmount.ToString("C0", cultureVN)</h3> 
    </div>

    <div class="text-center mb-4">
        <a asp-controller="Home" asp-action="Index" class="btn btn-primary" style="border-radius: 5px; font-size: 18px;">
            Continue Shopping
        </a>
    </div>

    
    <form method="POST" asp-controller="Payment" asp-action="CreatePaymentUrlVnpay">
        <input type="hidden" name="Name" value="@User.Identity.Name" />
        <input type="hidden" name="OrderDescription" value="Thanh toán đơn hàng Sweet Dream" />
        <input type="hidden" name="Amount" value="@( (int)(totalAmount) )" />
        <input type="hidden" name="OrderType" value="other"></input>
        <button type="submit" class="btn btn-success" style="font-size: 18px; padding: 10px 30px;">
            Thanh toán qua VNPAY
        </button>
    </form>

    <div class="text-center mt-4">
        <button id="showQrBtn" type="button" class="btn btn-outline-info" style="font-size: 18px; padding: 10px 30px;">
            Thanh toán trực tuyến
        </button>
    </div>

    <div id="qrSection" class="text-center mt-4" style="display: none;">
        <h4>Quét mã để thanh toán</h4>
        <img id="qrImage" alt="QR Code thanh toán" style="max-width: 300px; margin: 20px auto;" />
        <p style="font-weight: bold; color: green;">Số tiền: @totalAmount.ToString("C0", cultureVN)</p>
    </div>
        <form method="post" asp-action="OrderSubmitted" asp-controller="Checkout" asp-antiforgery="true">
            <input type="hidden" name="orderId" value="@Model.OId" />
            <button type="submit" class="btn btn-warning mt-3" style="font-size: 18px; padding: 10px 30px;">
                ✅ Tôi đã thanh toán
            </button>
        </form>
    @section Scripts {
        <script>
            document.getElementById("showQrBtn").addEventListener("click", function () {
                var amount = @totalAmount;
                var bankCode = "mbbank"; // <-- thay bằng mã ngân hàng của bạn
                var accountNumber = "140112126868"; // <-- thay bằng số tài khoản của bạn
                var info = "THANH TOAN DON HANG @Model.OId co ten @Model.OrderDetails"; // Ghi chú thanh toán

                var qrUrl = `https://img.vietqr.io/image/${bankCode}-${accountNumber}-compact2.png?amount=${amount}&addInfo=${encodeURIComponent(info)}`;

                document.getElementById("qrImage").src = qrUrl;
                document.getElementById("qrSection").style.display = "block";
            });
        </script>
    }

</div>